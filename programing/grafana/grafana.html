<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafana モニタリングツールの導入</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* Custom styles for prose content */
        .prose h1, .prose h2, .prose h3, .prose h4 {
            font-weight: 700;
            color: #1f2937; /* gray-800 */
        }
        .prose h4 {
            font-style: italic;
            color: #374151; /* gray-700 */
        }
        .prose pre {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .prose code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        }
        .prose ol, .prose ul {
            padding-left: 1.5rem;
        }
        .prose li > p {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">

    <main class="max-w-4xl mx-auto py-16 px-4">
        <div class="bg-white rounded-xl shadow-lg p-8 lg:p-12 prose max-w-none">
            
            <h1>GRAFANA</h1>
            <h2>モニタリングツールの導入</h2>
            <p>
                Grafanaを用いたモニタリングツールを導入します。必要なスクリプトは以下のGitHubリポジトリにまとめてあります。
                このREADMEを参照しながら実行することで、広島サイトではホストサーバー(grid02)から各ノードの監視を行っています。
            </p>

            <a href="https://github.com/mochimochino/setup_prometheus_grafana" target="_blank" rel="noopener noreferrer" class="block my-8 p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-lg transition-shadow no-underline">
                <div class="flex items-start space-x-4">
                    <img src="https://github.githubassets.com/favicons/favicon.svg" alt="GitHub Favicon" class="w-6 h-6 mt-1">
                    <div>
                        <div class="font-bold text-indigo-700 text-lg">GitHub - mochimochino/setup_prometheus_grafana</div>
                        <p class="text-gray-600 mt-1 text-base">Contribute to mochimochino/setup_prometheus_grafana development by creating an account on GitHub.</p>
                        <div class="text-sm text-gray-500 mt-2">github.com</div>
                    </div>
                </div>
            </a>
            
            <hr class="my-10">

            <h3>アラートの設定</h3>
            <p>Grafanaから異常を検知したときに、Gmailへアラートが飛ぶように設定を行います。</p>
            
            <h3>設定手順（Gmail通知）</h3>
            <p>Grafanaのアラート設定は大きく4ステップで構成されます。</p>
            <ol class="list-decimal space-y-2 font-semibold">
                <li>アラートルールの作成</li>
                <li>通知先の作成</li>
                <li>通知ポリシーの設定</li>
                <li>SMTP設定</li>
            </ol>

            <h4>Step 1: アラートルールの作成</h4>
            <p>アラートを発動させる条件を定義します。</p>
            <ol class="list-decimal space-y-4">
                <li>Grafanaの左側メニューから <strong>Alerting → Alert rules</strong> を開きます。</li>
                <li><strong>New alert rule</strong> をクリックします。</li>
                <li>
                    <p><strong>クエリと条件の設定 (Set up queries and expressions)</strong></p>
                    <ul class="list-disc pl-6 space-y-2">
                        <li><strong>A (Query):</strong> 監視したいデータ（メトリクス）を選択します。 (例: サーバーのCPU使用率やディスク空き容量など)</li>
                        <li><strong>B (Expression):</strong> アラートを発動させる「しきい値」を設定します。<code>Classic condition</code>を選択し、<code>WHEN last() OF B IS ABOVE 80</code> のように記述します。（意味：クエリBの結果が80を超えたら）</li>
                    </ul>
                </li>
                <li>
                    <p><strong>ルールの詳細設定 (Add details for your alert rule)</strong></p>
                    <ul class="list-disc pl-6 space-y-2">
                        <li><strong>Rule name:</strong> アラートルールの名前を入力します。（例: <code>High CPU Usage</code>）</li>
                        <li><strong>Evaluate every:</strong> アラート条件をチェックする頻度を設定します。（例: <code>1m</code> = 1分ごと）</li>
                        <li><strong>For:</strong> 条件が継続したらアラートを確定させる時間を設定します。（例: <code>5m</code> = 5分間継続したら）※一時的なスパイクでの誤報を防ぎます。</li>
                        <li><strong>Summary and annotations:</strong> 通知メールの件名や本文になる内容を記述します。</li>
                    </ul>
                </li>
                <li>最後に <strong>Save rule and exit</strong> をクリックして保存します。</li>
            </ol>

            <h4>Step 2: 通知先 (Contact Point) の作成</h4>
            <p>アラート通知を送るメールアドレスを登録します。</p>
            <ol class="list-decimal space-y-4">
                <li><strong>Alerting → Contact points</strong> を開きます。</li>
                <li><strong>New contact point</strong> をクリックします。</li>
                <li><strong>Name:</strong> 通知先の名前を入力します。（例: <code>Gmail Admins</code>）</li>
                <li><strong>Integration:</strong> <code>Email</code> を選択します。</li>
                <li><strong>Addresses:</strong> 通知を受け取りたいアドレスを入力します。（今回は大学メールを設定しました）</li>
                <li><strong>Save contact point</strong> をクリックします。</li>
            </ol>
            
            <h4>Step 3: 通知ポリシー (Notification Policy) の設定</h4>
            <p>どのアラートルールが発動したときに、どの通知先に連絡するかを関連付けます。（今回はすべての通知をデフォルトの通知先に送る設定です。）</p>
             <ol class="list-decimal space-y-4">
                <li><strong>Alerting → Notification policies</strong> を開きます。</li>
                <li><strong>Default contact point</strong> のドロップダウンメニューから、先ほど作成した <code>Gmail Admins</code> を選択します。</li>
                <li><strong>Save policy</strong> をクリックします。</li>
            </ol>

            <h4>Step 4: SMTP設定 (Grafanaからメールを送るための設定)</h4>
            <p>GrafanaがGmailのサーバーを使ってメールを送信できるように設定します。（Googleアカウントを新規作成して行いました。）</p>
             <ol class="list-decimal space-y-4">
                <li>
                    <p><strong>【Google側での準備】</strong></p>
                    <ul class="list-disc pl-6 space-y-2">
                        <li>お使いのGoogleアカウントで「2段階認証プロセス」を有効にします。</li>
                        <li>Grafana専用の「アプリパスワード」（16桁）を生成します。（一度しか表示されないので注意）</li>
                    </ul>
                </li>
                <li>
                    <p><strong>【Grafana側での設定】</strong></p>
                    <p>Grafanaの設定ファイル <code>/etc/grafana/grafana.ini</code> を開き、<code>[smtp]</code> セクションを以下のように編集・保存します。</p>
                    <pre><code>[smtp]
enabled = true
host = smtp.gmail.com:587
user = your-email@gmail.com
# If the password contains # or ; you have to wrap it with triple quotes. Ex """#password;"""
password = abcd efgh ijkl mnop
skip_verify = false
from_address = your-email@gmail.com
from_name = Grafana Alerts
</code></pre>
                </li>
                <li>
                    <p><strong>【Grafanaの再起動】</strong></p>
                    <p>設定ファイルを保存し、Grafanaサーバーを再起動して設定を反映させます。</p>
                    <pre><code>sudo systemctl restart grafana-server</code></pre>
                </li>
            </ol>

            <h4>Step 5: 最終テスト</h4>
            <p>全ての設定が完了したら、動作確認を行います。</p>
            <ol class="list-decimal space-y-4">
                 <li><strong>Alerting → Contact points</strong> を再度開きます。</li>
                 <li>作成した <code>Gmail Admins</code> の右側にある <strong>Test</strong> ボタンをクリックします。</li>
                 <li>テスト通知の画面が表示されたら <strong>Send test notification</strong> をクリックします。</li>
            </ol>
            <p>指定したGmailアドレスに「<code>[FIRING:1] (Test notification)</code>」のような件名のテストメールが届けば成功です。</p>

            <div class="mt-16 text-center">
                <a href="/programing/main.html" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors no-underline">
                    ← ツール特集に戻る
                </a>
            </div>
        </div>
    </main>

</body>
</html>